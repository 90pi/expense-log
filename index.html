<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expenses</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCUcge8_Ax1VPLpT8bEaYeJBUH490fwmfw",
  authDomain: "savelog-3f29f.firebaseapp.com",
  databaseURL: "https://savelog-3f29f-default-rtdb.firebaseio.com",
  projectId: "savelog-3f29f",
  storageBucket: "savelog-3f29f.appspot.com",
  messagingSenderId: "858364008456",
  appId: "1:858364008456:web:b021827fd90120d8f2d9bd"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    font-size: 1.2rem;
    align-items: flex-start;
  }
  h1 {
    cursor: pointer;
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
  select, input {
    background: #222;
    color: #eee;
    border: none;
    padding: 0.5rem;
    font-size: 1.2rem;
    margin: 0.5rem 0;
  }
  .expenses {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
    width: 100%;
  }
  .expense-group {
    margin-bottom: 1rem;
  }
  .expense-date {
    color: #888;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #333;
  }
  .expense {
    padding: 0.5rem 0;
    font-size: 1.5rem;
    position: relative;
    cursor: pointer;
  }
  .expense.editing::after {
    content: 'x';
    color: red;
    position: absolute;
    top: -0.5rem;
    right: -0.5rem;
    cursor: pointer;
  }
  .total {
    margin: 1rem 0;
    font-size: 2rem;
  }
  .hidden { display: none; }
</style>
</head>
<body>

<h1 onclick="showMenu()">Expense Tracker</h1>

<div id="menu" class="hidden">
  <button onclick="goHome()">Home</button>
  <button onclick="exportData()">Export Data</button>
  <input type="file" id="importFile" accept=".txt,.json" onchange="importData(event)">
</div>

<select id="monthSelect" onchange="loadExpenses()"></select>

<div class="total" id="total"></div>

<input id="amountInput" type="number" placeholder="Enter amount (₹)" onkeydown="handleKey(event)">

<div class="expenses" id="expenses"></div>

<script>
// Global variables
let expensesData = {};
let editingIndex = -1;

// DOM elements
const monthSelect = document.getElementById('monthSelect');
const expensesDiv = document.getElementById('expenses');
const totalDiv = document.getElementById('total');
const input = document.getElementById('amountInput');
const menu = document.getElementById('menu');
const importFile = document.getElementById('importFile');

// Month names
const months = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'
];

// Initialize with current month
const now = new Date();
let currentMonth = `${months[now.getMonth()]}${now.getFullYear()}`;

// Initialize month dropdown
function initMonthSelect() {
  monthSelect.innerHTML = '';
  months.forEach((m, i) => {
    const key = `${m}${now.getFullYear()}`;
    const option = document.createElement('option');
    option.value = key;
    option.text = `${m} ${now.getFullYear()}`;
    if (key === currentMonth) option.selected = true;
    monthSelect.appendChild(option);
  });
}

// Load data from Firebase
function loadFirebaseData() {
  db.ref('expenses').once('value').then(snapshot => {
    console.log('Firebase data loaded:', snapshot.val());
    
    if (!snapshot.exists()) {
      console.log('No data found, initializing empty database');
      expensesData = {};
      db.ref('expenses').set({});
    } else {
      expensesData = snapshot.val() || {};
    }
    
    updateMonthSelect();
    loadExpenses();
  }).catch(error => {
    console.error('Firebase error:', error);
    fallbackToLocalStorage();
  });
}

// Fallback to local storage if Firebase fails
function fallbackToLocalStorage() {
  const localData = localStorage.getItem('expenses');
  if (localData) {
    console.log('Using local storage data');
    expensesData = JSON.parse(localData);
  } else {
    console.log('No local data found, starting fresh');
    expensesData = {};
  }
  updateMonthSelect();
  loadExpenses();
}

// Save data to both Firebase and local storage
function saveExpenses() {
  console.log('Saving data:', expensesData);
  localStorage.setItem('expenses', JSON.stringify(expensesData));
  db.ref('expenses').set(expensesData).catch(error => {
    console.error('Error saving to Firebase:', error);
  });
}

// Main function to load and display expenses
function loadExpenses() {
  currentMonth = monthSelect.value;
  expensesDiv.innerHTML = '';
  const monthData = expensesData[currentMonth] || [];
  let total = 0;

  // Group by date
  const groupedExpenses = {};
  monthData.forEach(expense => {
    const date = new Date(expense.date);
    const dateKey = date.toDateString();
    groupedExpenses[dateKey] = groupedExpenses[dateKey] || [];
    groupedExpenses[dateKey].push(expense);
  });

  // Sort dates (newest first)
  const sortedDates = Object.keys(groupedExpenses).sort((a, b) => new Date(b) - new Date(a));

  // Display each date group
  sortedDates.forEach(dateKey => {
    const date = new Date(dateKey);
    const dateStr = `${date.getDate()} ${months[date.getMonth()]}`;
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'expense-group';
    
    const dateHeading = document.createElement('div');
    dateHeading.className = 'expense-date';
    dateHeading.textContent = dateStr;
    groupDiv.appendChild(dateHeading);

    // Add each expense for this date
    groupedExpenses[dateKey].forEach((expense, idx) => {
      const originalIndex = monthData.findIndex(e => 
        e.date === expense.date && e.amount === expense.amount);
      
      const div = document.createElement('div');
      div.className = editingIndex === originalIndex ? 'expense editing' : 'expense';
      div.onclick = () => editExpense(originalIndex);
      div.textContent = '₹' + expense.amount;
      
      groupDiv.appendChild(div);
      total += Number(expense.amount);
    });

    expensesDiv.appendChild(groupDiv);
  });

  totalDiv.textContent = `Total: ₹${total}`;
}

// Handle keyboard input
function handleKey(e) {
  if (e.key === 'Enter') {
    addExpense();
  }
}

// Add or update expense
function addExpense() {
  const val = input.value.trim();
  if (!val || isNaN(val)) {
    alert('Please enter a valid number');
    return;
  }

  expensesData[currentMonth] = expensesData[currentMonth] || [];

  if (editingIndex >= 0) {
    // Update existing
    expensesData[currentMonth][editingIndex].amount = val;
    expensesData[currentMonth][editingIndex].date = new Date().toISOString();
    editingIndex = -1;
  } else {
    // Add new
    expensesData[currentMonth].push({
      amount: val,
      date: new Date().toISOString()
    });
  }

  saveExpenses();
  input.value = '';
  loadExpenses();
  input.focus();
}

// Update month dropdown with available data
function updateMonthSelect() {
  monthSelect.innerHTML = '';
  const allMonths = Object.keys(expensesData).sort().reverse();
  
  if (allMonths.length === 0) {
    initMonthSelect();
    return;
  }

  allMonths.forEach(key => {
    const option = document.createElement('option');
    option.value = key;
    option.text = key.replace(/([A-Za-z]+)(\d+)/, '$1 $2');
    if (key === currentMonth) option.selected = true;
    monthSelect.appendChild(option);
  });
}

// Edit or delete expense
function editExpense(idx) {
  if (editingIndex === idx) {
    if (confirm('Delete this expense?')) {
      expensesData[currentMonth].splice(idx, 1);
      editingIndex = -1;
      saveExpenses();
      loadExpenses();
    }
  } else {
    input.value = expensesData[currentMonth][idx].amount;
    editingIndex = idx;
    loadExpenses();
    input.focus();
  }
}

// UI functions
function showMenu() {
  menu.classList.toggle('hidden');
}

function goHome() {
  location.reload();
}

function exportData() {
  const blob = new Blob([JSON.stringify(expensesData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `expenses_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      if (typeof importedData === 'object' && importedData !== null) {
        if (confirm('Replace all current data with imported data?')) {
          expensesData = importedData;
          saveExpenses();
          loadExpenses();
        }
      } else {
        alert('Invalid data format');
      }
    } catch (err) {
      alert('Error parsing file: ' + err.message);
    }
    importFile.value = ''; // Reset file input
  };
  reader.readAsText(file);
}

// Initialize app
initMonthSelect();
loadFirebaseData();
</script>

</body>
</html>
