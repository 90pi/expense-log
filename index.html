<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expenses</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyD6MmrZtOZDmsnrzLVnqHmCDJwvRiYH3zQ",
  authDomain: "save-log.firebaseapp.com",
  databaseURL: "https://save-log-default-rtdb.firebaseio.com",
  projectId: "save-log",
  storageBucket: "save-log.firebasestorage.app",
  messagingSenderId: "202094279515",
  appId: "1:202094279515:web:d1ffa8011b204ddd45387e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    font-size: 1.2rem;
    align-items: flex-start;
  }

  h1 {
    cursor: pointer;
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  select, input {
    background: #222;
    color: #eee;
    border: none;
    padding: 0.5rem;
    font-size: 1.2rem;
    margin: 0.5rem 0;
  }

  .expenses {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
    width: 100%;
  }

  .expense-group {
    margin-bottom: 1rem;
  }

  .expense-date {
    color: #888;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #333;
  }

  .expense {
    padding: 0.5rem 0;
    font-size: 1.5rem;
    position: relative;
    cursor: pointer;
  }

  .expense.editing::after {
    content: 'x';
    color: red;
    position: absolute;
    top: -0.5rem;
    right: -0.5rem;
    cursor: pointer;
  }

  .total {
    margin: 1rem 0;
    font-size: 2rem;
  }

  .hidden { display: none; }
</style>
</head>
<body>

<h1 onclick="showMenu()">Expense Tracker</h1>

<div id="menu" class="hidden">
  <button onclick="goHome()">Home</button>
  <button onclick="exportData()">Export Data</button>
  <input type="file" onchange="importData(event)">
</div>

<select id="monthSelect" onchange="loadExpenses()"></select>

<div class="total" id="total"></div>

<input id="amountInput" type="number" placeholder="Enter amount (₹)" onkeydown="handleKey(event)">

<div class="expenses" id="expenses"></div>

<script>
let expensesData = {};

db.ref('expenses').once('value').then(snapshot => {
  expensesData = snapshot.val() || {};
  updateMonthSelect();
  loadExpenses();
});
const monthSelect = document.getElementById('monthSelect');
const expensesDiv = document.getElementById('expenses');
const totalDiv = document.getElementById('total');
const input = document.getElementById('amountInput');
const menu = document.getElementById('menu');

const months = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'
];

const now = new Date();
let currentMonth = `${months[now.getMonth()]}${now.getFullYear()}`;

months.forEach((m, i) => {
  const key = `${m}${now.getFullYear()}`;
  const option = document.createElement('option');
  option.value = key;
  option.text = `${m} ${now.getFullYear()}`;
  if (key === currentMonth) option.selected = true;
  monthSelect.appendChild(option);
});

function saveExpenses() {
  localStorage.setItem('expenses', JSON.stringify(expensesData)); // optional local backup
  db.ref('expenses').set(expensesData);
}

function loadExpenses() {
  currentMonth = monthSelect.value;
  expensesDiv.innerHTML = '';
  const monthData = expensesData[currentMonth] || [];
  let total = 0;

  // Group expenses by date
  const groupedExpenses = {};
  monthData.forEach(expense => {
    const date = new Date(expense.date);
    const dateKey = date.toDateString();
    if (!groupedExpenses[dateKey]) {
      groupedExpenses[dateKey] = [];
    }
    groupedExpenses[dateKey].push(expense);
  });

  // Sort dates (newest first)
  const sortedDates = Object.keys(groupedExpenses).sort((a, b) => new Date(b) - new Date(a));

  sortedDates.forEach(dateKey => {
    const date = new Date(dateKey);
    const dateStr = `${date.getDate()} ${months[date.getMonth()]}`;
    
    // Create date group container
    const groupDiv = document.createElement('div');
    groupDiv.className = 'expense-group';
    
    // Add date heading
    const dateHeading = document.createElement('div');
    dateHeading.className = 'expense-date';
    dateHeading.textContent = dateStr;
    groupDiv.appendChild(dateHeading);

    // Add expenses for this date
    groupedExpenses[dateKey].forEach((expense, idx) => {
      const originalIndex = monthData.findIndex(e => e.date === expense.date && e.amount === expense.amount);
      
      const div = document.createElement('div');
      div.className = editingIndex === originalIndex ? 'expense editing' : 'expense';
      div.onclick = () => editExpense(originalIndex);
      div.textContent = '₹' + expense.amount;
      
      groupDiv.appendChild(div);
      total += Number(expense.amount);
    });

    expensesDiv.appendChild(groupDiv);
  });

  totalDiv.textContent = `Total: ₹${total}`;
}

let editingIndex = -1;

function handleKey(e) {
  if (e.key === 'Enter') addExpense();
}

function addExpense() {
  const val = input.value.trim();
  if (!val) return;

  expensesData[currentMonth] = expensesData[currentMonth] || [];

  if (editingIndex >= 0) {
    expensesData[currentMonth][editingIndex].amount = val;
    expensesData[currentMonth][editingIndex].date = new Date().toISOString();
    editingIndex = -1;
  } else {
    expensesData[currentMonth].push({
      amount: val,
      date: new Date().toISOString()
    });
  }

  saveExpenses();
  input.value = '';
  loadExpenses();
}
function updateMonthSelect(){
  monthSelect.innerHTML = '';
  Object.keys(expensesData).sort().reverse().forEach(key=>{
    const option = document.createElement('option');
    option.value = key;
    option.text = key.match(/[A-Za-z]+/) + ' ' + key.match(/[0-9]+/);
    if(key===currentMonth) option.selected = true;
    monthSelect.appendChild(option);
  });
}
function editExpense(idx) {
  if (editingIndex === idx) {
    if (confirm('Delete this expense?')) {
      expensesData[currentMonth].splice(idx, 1);
      editingIndex = -1;
      saveExpenses();
      loadExpenses();
    }
  } else {
    input.value = expensesData[currentMonth][idx].amount;
    editingIndex = idx;
    loadExpenses();
  }
}

function showMenu() {
  menu.classList.toggle('hidden');
}

function goHome() {
  location.reload();
}

function exportData() {
  const blob = new Blob([JSON.stringify(expensesData)], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'expenses.txt';
  a.click();
  URL.revokeObjectURL(url);
}

const firebaseConfig = {
  apiKey: "AIzaSyD6MmrZtOZDmsnrzLVnqHmCDJwvRiYH3zQ",
  authDomain: "save-log.firebaseapp.com",
  databaseURL: "https://save-log-default-rtdb.firebaseio.com",
  projectId: "save-log",
  storageBucket: "save-log.firebasestorage.app",
  messagingSenderId: "202094279515",
  appId: "1:202094279515:web:d1ffa8011b204ddd45387e"
};

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    expensesData = JSON.parse(e.target.result);
    saveExpenses();
    loadExpenses();
  }
  reader.readAsText(file);
}

loadExpenses();
</script>

</body>
</html>
